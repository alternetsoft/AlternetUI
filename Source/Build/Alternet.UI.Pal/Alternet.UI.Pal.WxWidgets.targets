<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <Target Name="CleanWxWidgets">
        <RemoveDir Directories="$(WxWidgetsDirectory)" Condition="Exists($(WxWidgetsDirectory))"/>
    </Target>

    <Target Name="DownloadAndExtractWxWidgets">
        <DownloadFile Condition="!Exists($(WxWidgetsDownloadTargetPath))"
            SourceUrl="$(WxWidgetsDownloadUrl)"
            DestinationFolder="$(WxWidgetsDownloadDirectory)" DestinationFileName="$(WxWidgetsDownloadFileName)" />
        <Unzip SourceFiles="$(WxWidgetsDownloadTargetPath)" DestinationFolder="$(WxWidgetsDirectory)" />
        <Delete Files="$(WxWidgetsDownloadTargetPath)"/>
    </Target>

    <!-- Windows -->
    <Target Name="BuildWxWidgets_Windows" Condition="$([MSBuild]::IsOsPlatform('Windows'))">
        <!-- 32 Bit Release -->
        <Exec
            WorkingDirectory="$(WxWidgetsWindowsBuildDirectory)"
            Command="cmd.exe /s /c &quot; &quot;$(VCVarsAllPath)&quot; x86 &amp;&amp; nmake /f makefile.vc BUILD=release TARGET_CPU=X86 RUNTIME_LIBS=static &quot;" />

        <!-- 32 Bit Debug -->
        <Exec Condition="'$(ReleaseOnlyWxWidgetsBuild)' != 'true'"
            WorkingDirectory="$(WxWidgetsWindowsBuildDirectory)"
            Command="cmd.exe /s /c &quot; &quot;$(VCVarsAllPath)&quot; x86 &amp;&amp; nmake /f makefile.vc BUILD=debug TARGET_CPU=X86 RUNTIME_LIBS=static &quot;" />

        <!-- 64 Bit Release -->
        <Exec
            WorkingDirectory="$(WxWidgetsWindowsBuildDirectory)"
            Command="cmd.exe /s /c &quot; &quot;$(VCVarsAllPath)&quot; x64 &amp;&amp; nmake /f makefile.vc BUILD=release TARGET_CPU=X64 RUNTIME_LIBS=static &quot;" />

        <!-- 64 Bit Debug -->
        <Exec Condition="'$(ReleaseOnlyWxWidgetsBuild)' != 'true'"
            WorkingDirectory="$(WxWidgetsWindowsBuildDirectory)"
            Command="cmd.exe /s /c &quot; &quot;$(VCVarsAllPath)&quot; x64 &amp;&amp; nmake /f makefile.vc BUILD=debug TARGET_CPU=X64 RUNTIME_LIBS=static &quot;" />
    </Target>

    <!-- Linux -->
    <Target Name="BuildWxWidgets_Linux" Condition="$([MSBuild]::IsOsPlatform('Linux'))">
        <Exec WorkingDirectory="$(WxWidgetsDirectory)" Command="chmod +x configure" />
        <Exec WorkingDirectory="$(WxWidgetsDirectory)" 
			Command="mkdir $(WxWidgetsGtkBuildDirectoryName)" 
			Condition="!Exists($(WxWidgetsGtkBuildDirectory))"/>

        <!-- Debug -->
        <Exec 	WorkingDirectory="$(WxWidgetsGtkBuildDirectory)" 
				Command="../configure --enable-webview --enable-webviewwebkit --enable-debug --disable-shared" 
				Condition="'$(DebugWxWidgetsBuild)' == 'true'"/>

        <!-- Release -->
        <Exec 	WorkingDirectory="$(WxWidgetsGtkBuildDirectory)" 
				Command="../configure --enable-webview --enable-webviewwebkit --disable-shared" 
				Condition="'$(DebugWxWidgetsBuild)' != 'true'"/>
        <Exec WorkingDirectory="$(WxWidgetsGtkBuildDirectory)" Command="make -j20" />
    </Target>

    <!-- MacOS -->
    <Target Name="BuildWxWidgets_MacOS" Condition="$([MSBuild]::IsOsPlatform('OSX'))">
        <Exec WorkingDirectory="$(WxWidgetsDirectory)" Command="chmod +x configure" />
        <Exec WorkingDirectory="$(WxWidgetsDirectory)" 
			Command="mkdir $(WxWidgetsMacOSBuildDirectoryName)" 
			Condition="!Exists($(WxWidgetsMacOSBuildDirectory))"			
		/>

        <PropertyGroup>
            <ConfigureCommand>../configure</ConfigureCommand>
            <DebugFlag>--enable-debug</DebugFlag>
    
            <!-- On macOS High Sierra (10.13.6, the minimum supported version), libtiff, expat, pcre fail to build. So have to exclude them. -->
            <ConfigureCommandParameters>--disable-shared --enable-webview --enable-webviewwebkit --disable-sys-libs --with-macosx-version-min=10.13 --without-libtiff --without-expat --without-regex</ConfigureCommandParameters>
        </PropertyGroup>
        
        <!-- Debug -->
        <CreateProperty
            Condition="'$(DebugWxWidgetsBuild)' == 'true'"
            Value="$(ConfigureCommand) $(DebugFlag) $(ConfigureCommandParameters)">
            <Output TaskParameter="Value" PropertyName="ConfigureCommandLine" />  
        </CreateProperty>  

        <!-- Release -->
        <CreateProperty
            Condition="'$(DebugWxWidgetsBuild)' != 'true'"
            Value="$(ConfigureCommand) $(ConfigureCommandParameters)">
            <Output TaskParameter="Value" PropertyName="ConfigureCommandLine" />  
        </CreateProperty>  

        <Exec WorkingDirectory="$(WxWidgetsMacOSBuildDirectory)" Command="$(ConfigureCommandLine)" />
        
        <Exec WorkingDirectory="$(WxWidgetsMacOSBuildDirectory)" Command="make -j20" />
    </Target>

    <Target Name="BuildWxWidgets">
        <CallTarget Targets="CleanWxWidgets" />
        <CallTarget Targets="DownloadAndExtractWxWidgets" />
        <CallTarget Targets="BuildWxWidgets_Windows" />
        <CallTarget Targets="BuildWxWidgets_Linux" />
        <CallTarget Targets="BuildWxWidgets_MacOS" />
    </Target>

    <Target Name="CleanWxWidgetsBuildDirectory">
        <RemoveDir Directories="$(WxWidgetsMacOSBuildDirectory)" Condition="Exists($(WxWidgetsMacOSBuildDirectory))"/>
        <RemoveDir Directories="$(WxWidgetsGtkBuildDirectory)" Condition="Exists($(WxWidgetsGtkBuildDirectory))"/>
        <RemoveDir Directories="$(WxWidgetsWindowsBuildDirectory)" Condition="Exists($(WxWidgetsWindowsBuildDirectory))"/>
    </Target>

    <Target Name="BuildWxWidgetsWithoutDownload">
        <CallTarget Targets="CleanWxWidgetsBuildDirectory" />
        <CallTarget Targets="BuildWxWidgets_Windows" />
        <CallTarget Targets="BuildWxWidgets_Linux" />
        <CallTarget Targets="BuildWxWidgets_MacOS" />
    </Target>
</Project>